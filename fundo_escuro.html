<!doctype html>
<html lang="pt-BR">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>PDV - Bar do Gigante</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        dourado: '#D4AF37',
                        douradoEscuro: '#B8941F',
                        preto: '#1a1a1a',
                        cinzaEscuro: '#2d2d2d',
                    }
                }
            }
        }
    </script>

    <style>
        /* Visual tweaks gerais */
        body {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            /* CORRE√á√ÉO CHAVE: Garante que o body n√£o tenha scroll, permitindo que a div #root controle tudo */
            overflow: hidden; 
        }

        /* Ajuste de altura para a barra lateral */
        .sidebar-scroll {
            /* Permite o scroll na sidebar se houver muitos itens, mas o scroll principal √© no <main> */
            overflow-y: auto;
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #D4AF37, #B8941F);
            border-radius: 999px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        /* Logo do Bar (Mantenha o estilo para o Login) */
        .logo-bar {
            width: 120px;
            height: 120px;
            margin: 0 auto;
            background: #1a1a1a;
            border-radius: 50%;
            border: 3px solid #D4AF37;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 30px rgba(212, 175, 55, 0.5);
        }

        .logo-inner {
            width: 110px;
            height: 110px;
            border-radius: 50%;
            border: 2px solid #ffffff;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #2d2d2d 0%, #1a1a1a 100%);
            padding: 10px;
        }

        .logo-stars {
            display: flex;
            gap: 3px;
            margin-bottom: 5px;
        }

        .star {
            color: #D4AF37;
            font-size: 11px;
        }

        .logo-text {
            text-align: center;
        }

        .logo-bar-text {
            font-size: 22px;
            font-weight: bold;
            color: #D4AF37;
            letter-spacing: 2px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            line-height: 1;
        }

        .logo-do-gigante {
            font-size: 12px;
            font-weight: bold;
            color: #ffffff;
            margin-top: 3px;
            letter-spacing: 1px;
        }
    </style>
</head>

<body class="bg-gradient-to-br from-cinzaEscuro via-preto to-cinzaEscuro">

    <div id="root" class="min-h-screen"></div> 

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        /**********************
         * Utilit√°rios & Init *
         **********************/
        const initialProdutosDefault = [
            { id: 1, nome: "Coca-Cola 2L", preco: 8.5, estoque: 50, categoria: "Bebidas" },
            { id: 2, nome: "Cerveja Skol Lata", preco: 3.2, estoque: 120, categoria: "Bebidas" },
            { id: 3, nome: "Cigarro Marlboro", preco: 12.0, estoque: 30, categoria: "Cigarros" },
            { id: 4, nome: "Palito de Dente", preco: 0.5, estoque: 200, categoria: "Diversos" },
            { id: 5, nome: "√Ågua Mineral 500ml", preco: 2.0, estoque: 100, categoria: "Bebidas" },
            { id: 6, nome: "Cacha√ßa 51", preco: 15.0, estoque: 10, categoria: "Destilados" },
            { id: 7, nome: "Salgadinho Elma Chips", preco: 4.5, estoque: 45, categoria: "Petiscos" },
            { id: 8, nome: "Pinga Artesanal", preco: 25.0, estoque: 5, categoria: "Destilados" },
        ];

        function uid() { return Date.now() + Math.floor(Math.random() * 9999); }
        function currency(v) { return 'R$ ' + Number(v || 0).toFixed(2).replace('.', ','); } // Formatado para PT-BR

        function storageGet(key, fallback = null) { try { const raw = localStorage.getItem(key); if (raw) return JSON.parse(raw); return fallback; } catch (e) { return fallback; } }
        function storageSet(key, value) { try { localStorage.setItem(key, JSON.stringify(value)); } catch (e) { } }

        /**********
         * Login *
         **********/
        const defaultUser = { username: 'admin', password: '1234' };

        function Login({ onLogin }) {
            const [u, setU] = useState('');
            const [p, setP] = useState('');
            const [err, setErr] = useState('');

            function submit(e) {
                e.preventDefault();
                if (u === defaultUser.username && p === defaultUser.password) {
                    onLogin({ username: u });
                } else {
                    setErr('Usu√°rio ou senha inv√°lidos');
                }
            }

            return (
                <div className="min-h-screen flex items-center justify-center p-6">
                    <div className="max-w-4xl w-full grid grid-cols-1 md:grid-cols-2 gap-8 items-center">

                        {/* Painel visual */}
                        <div className="hidden md:flex flex-col items-center justify-center rounded-2xl p-8 bg-cinzaEscuro shadow-xl border-2 border-dourado">
                            <div className="logo-bar mb-4">
                                <div className="logo-inner">
                                    <div className="logo-stars">
                                        <span className="star">‚òÖ</span>
                                        <span className="star">‚òÖ</span>
                                        <span className="star">‚òÖ</span>
                                        <span className="star">‚òÖ</span>
                                        <span className="star">‚òÖ</span>
                                    </div>
                                    <div className="logo-text">
                                        <div className="logo-bar-text">BAR</div>
                                        <div className="logo-do-gigante">DO GIGANTE</div>
                                    </div>
                                </div>
                            </div>
                            <h1 className="text-3xl font-extrabold text-dourado">Bar do Gigante</h1>
                            <p className="mt-2 text-gray-300">PDV moderno e funcional</p>
                            <div className="mt-6 text-sm text-gray-400">Dica: usu√°rio padr√£o <b className="text-dourado">admin</b> / senha <b className="text-dourado">1234</b></div>
                        </div>

                        {/* Form */}
                        <form onSubmit={submit} className="bg-cinzaEscuro border-2 border-dourado rounded-2xl p-6 shadow-lg">
                            <div className="flex items-center justify-between mb-6">
                                <div>
                                    <h2 className="text-2xl font-bold text-dourado">Entrar</h2>
                                    <p className="text-sm text-gray-300">Acesse o sistema PDV</p>
                                </div>
                                <div className="text-2xl">üîí</div>
                            </div>

                            <label className="block mb-4">
                                <span className="text-sm text-gray-300">Usu√°rio</span>
                                <input className="mt-1 block w-full p-3 border border-dourado bg-preto text-white rounded-xl focus:outline-none focus:ring-2 focus:ring-dourado transition" value={u} onChange={e => setU(e.target.value)} required />
                            </label>

                            <label className="block mb-4">
                                <span className="text-sm text-gray-300">Senha</span>
                                <input type="password" className="mt-1 block w-full p-3 border border-dourado bg-preto text-white rounded-xl focus:outline-none focus:ring-2 focus:ring-dourado transition" value={p} onChange={e => setP(e.target.value)} required />
                            </label>

                            {err && <div className="text-red-400 mb-3">{err}</div>}

                            <button className="w-full py-3 rounded-xl font-bold bg-gradient-to-r from-dourado to-douradoEscuro text-preto shadow-md hover:shadow-lg transform hover:-translate-y-0.5 transition">Entrar</button>

                            <div className="mt-4 text-center text-xs text-gray-400">Suporte: <span className="text-dourado">suporte@bardogigante.local</span></div>
                        </form>

                    </div>
                </div>
            );
        }

        /****************
         * Header, Side *
         ****************/
        function Header({ user, onLogout }) {
            return (
                <header className="bg-cinzaEscuro border-b-2 border-dourado shadow sticky top-0 z-30 h-16 flex items-center">
                    <div className="max-w-7xl mx-auto px-4 w-full flex items-center justify-between">
                        <div className="flex items-center gap-4">
                            <div className="text-3xl">üçª</div>
                            <div>
                                <div className="text-lg font-bold text-dourado">Bar do Gigante</div>
                                <div className="text-xs text-gray-400 hidden sm:block">Sistema PDV</div>
                            </div>
                        </div>

                        <div className="flex items-center gap-4">
                            <div className="flex items-center gap-2 bg-preto border border-dourado px-3 py-1 rounded-full shadow-sm">
                                <div className="text-sm text-gray-300">üë§ {user?.username}</div>
                            </div>
                            <button onClick={onLogout} className="px-3 py-1 rounded-lg border border-dourado text-dourado hover:bg-dourado hover:text-preto transition">Sair</button>
                        </div>
                    </div>
                </header>
            );
        }

        function Sidebar({ selected, setSelected }) {
            const itens = [
                { key: 'pdv', label: 'üõí PDV' },
                { key: 'produtos', label: 'üì¶ Produtos' },
                { key: 'relatorios', label: 'üìä Relat√≥rios' },
                { key: 'avancado', label: 'üìà Relat√≥rio Avan√ßado' }
            ];
            return (
                <aside className="w-64 bg-cinzaEscuro border-r-2 border-dourado hidden md:block flex-shrink-0">
                    <div className="p-4 sidebar-scroll">
                        {itens.map(i => (
                            <button key={i.key} onClick={() => setSelected(i.key)}
                                className={`flex items-center gap-3 w-full text-left px-3 py-3 rounded-xl my-1 font-medium transition ${selected === i.key ? 'bg-gradient-to-r from-dourado to-douradoEscuro text-preto shadow-lg' : 'text-gray-300 hover:bg-preto hover:text-dourado border border-transparent hover:border-dourado'}`}>
                                <span className="text-lg">{i.label.split(' ')[0]}</span>
                                <span className="hidden sm:block">{i.label.split(' ').slice(1).join(' ')}</span>
                            </button>
                        ))}
                    </div>
                </aside>
            );
        }

        /**********
         * VIEWS *
         **********/
        function PDVView({ produtos, adicionarAoCarrinho, busca, setBusca, carrinho, alterarQuantidade, removerDoCarrinho, finalizarVenda, totalCarrinho }) {
            const produtosFiltrados = produtos.filter(p => p.nome.toLowerCase().includes(busca.toLowerCase()) || p.categoria.toLowerCase().includes(busca.toLowerCase()));

            return (
                <div className="space-y-4">
                    <div className="bg-cinzaEscuro border-2 border-dourado p-4 rounded-2xl shadow flex gap-3 items-center">
                        <input value={busca} onChange={e => setBusca(e.target.value)} placeholder="Pesquisar produto ou categoria" className="flex-1 p-3 border border-dourado bg-preto text-white rounded-xl focus:ring-2 focus:ring-dourado transition" />
                        <div className="text-sm text-gray-400 hidden sm:block">Clique no card para adicionar ‚ûï</div>
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div className="lg:col-span-2">
                            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                                {produtosFiltrados.map(produto => (
                                    <div key={produto.id}
                                        onClick={() => adicionarAoCarrinho(produto)}
                                        className="p-4 rounded-2xl border-2 border-dourado cursor-pointer shadow-sm hover:shadow-lg transform hover:-translate-y-1 transition bg-cinzaEscuro">

                                        <div className="flex items-start justify-between gap-3">
                                            <div>
                                                <div className="text-sm text-gray-400">{produto.categoria}</div>
                                                <div className="font-semibold text-lg mt-1 text-white">{produto.nome}</div>
                                            </div>

                                            <div className="text-right">
                                                <div className="text-dourado font-bold text-lg">{currency(produto.preco)}</div>
                                                <div className="text-xs mt-2">
                                                    {produto.estoque <= 10 ? (
                                                        <span className="inline-flex items-center gap-2 px-2 py-1 rounded-full text-red-400 bg-red-900/30 text-xs font-semibold">‚ö†Ô∏è {produto.estoque}</span>
                                                    ) : (
                                                        <span className="inline-flex items-center gap-2 px-2 py-1 rounded-full text-gray-300 bg-preto text-xs">üì¶ {produto.estoque}</span>
                                                    )}
                                                </div>
                                            </div>
                                        </div>

                                        <div className="mt-3 flex items-center justify-between">
                                            <div className="text-xs text-gray-400">Toque para adicionar</div>
                                            <div className="text-sm text-dourado font-semibold">Adicionar ‚ûï</div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>

                        <div className="bg-cinzaEscuro border-2 border-dourado p-4 rounded-2xl shadow h-full flex flex-col">
                            <h3 className="font-bold text-lg flex items-center gap-2 text-dourado">üßæ Carrinho</h3>

                            <div className="mt-3 flex-1 max-h-96 overflow-y-auto space-y-3">
                                {carrinho.map(item => (
                                    <div key={item.id} className="p-3 border border-dourado rounded-lg bg-preto">
                                        <div className="flex items-start justify-between">
                                            <div>
                                                <div className="font-medium text-white">{item.nome}</div>
                                                <div className="text-xs text-gray-400">{item.categoria}</div>
                                            </div>
                                            <div className="text-right">
                                                <div className="font-semibold text-dourado">{currency(item.preco * item.quantidade)}</div>
                                                <div className="text-xs text-gray-400">{currency(item.preco)} cada</div>
                                            </div>
                                        </div>

                                        <div className="mt-3 flex items-center gap-2">
                                            <button onClick={() => alterarQuantidade(item.id, item.quantidade - 1)} className="px-3 py-1 border border-dourado text-dourado rounded-lg hover:bg-dourado hover:text-preto transition">‚àí</button>
                                            <div className="px-3 text-white">{item.quantidade}</div>
                                            <button onClick={() => alterarQuantidade(item.id, item.quantidade + 1)} className="px-3 py-1 border border-dourado text-dourado rounded-lg hover:bg-dourado hover:text-preto transition">+</button>
                                            <button onClick={() => removerDoCarrinho(item.id)} className="ml-auto text-red-400 hover:underline">Remover</button>
                                        </div>
                                    </div>
                                ))}

                                {carrinho.length === 0 && <div className="text-gray-400 text-center py-6">Carrinho vazio ‚Äî adicione produtos</div>}
                            </div>

                            <div className="mt-auto pt-3 border-t border-dourado pt-3">
                                <div className="flex items-center justify-between font-bold text-lg mb-3">
                                    <div className="text-white">Total</div>
                                    <div className="text-dourado">{currency(totalCarrinho)}</div>
                                </div>
                                <button onClick={finalizarVenda} className="w-full py-3 rounded-xl font-bold bg-gradient-to-r from-dourado to-douradoEscuro text-preto shadow hover:shadow-lg transition">Finalizar Venda</button>
                            </div>

                        </div>
                    </div>
                </div>
            );
        }

        function ProdutosView({ produtos, salvarProdutos }) {
            const [form, setForm] = useState({ id: null, nome: '', preco: '', estoque: '', categoria: '' });

            function submit(e) {
                e.preventDefault();
                if (!form.nome || !form.preco || !form.estoque) return alert('Preencha os campos obrigat√≥rios');
                const novo = { ...form, preco: Number(form.preco), estoque: Number(form.estoque), id: form.id || uid() };
                let novos;
                if (form.id) novos = produtos.map(p => p.id === form.id ? novo : p);
                else novos = [...produtos, novo];
                salvarProdutos(novos);
                setForm({ id: null, nome: '', preco: '', estoque: '', categoria: '' });
            }

            function editar(p) { setForm({ ...p, preco: String(p.preco), estoque: String(p.estoque) }); }
            function excluir(p) { if (!confirm(`Excluir ${p.nome}?`)) return; salvarProdutos(produtos.filter(x => x.id !== p.id)); }

            return (
                <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div className="bg-cinzaEscuro border-2 border-dourado p-4 rounded-2xl shadow h-fit">
                        <h3 className="font-bold mb-3 text-dourado">{form.id ? 'Editar' : 'Novo'} Produto</h3>
                        <form onSubmit={submit} className="space-y-3">
                            <input value={form.nome} onChange={e => setForm({ ...form, nome: e.target.value })} placeholder="Nome" className="w-full p-3 border border-dourado bg-preto text-white rounded-xl focus:ring-2 focus:ring-dourado transition" required />
                            <input value={form.preco} onChange={e => setForm({ ...form, preco: e.target.value })} placeholder="Pre√ßo" type="number" step="0.01" className="w-full p-3 border border-dourado bg-preto text-white rounded-xl focus:ring-2 focus:ring-dourado transition" required />
                            <input value={form.estoque} onChange={e => setForm({ ...form, estoque: e.target.value })} placeholder="Estoque" type="number" className="w-full p-3 border border-dourado bg-preto text-white rounded-xl focus:ring-2 focus:ring-dourado transition" required />
                            <input value={form.categoria} onChange={e => setForm({ ...form, categoria: e.target.value })} placeholder="Categoria" className="w-full p-3 border border-dourado bg-preto text-white rounded-xl focus:ring-2 focus:ring-dourado transition" />

                            <div className="flex gap-3">
                                <button className="flex-1 py-3 bg-gradient-to-r from-dourado to-douradoEscuro text-preto rounded-xl font-semibold shadow">{form.id ? 'Atualizar' : 'Adicionar'}</button>
                                {form.id && <button type="button" onClick={() => setForm({ id: null, nome: '', preco: '', estoque: '', categoria: '' })} className="py-3 px-4 border border-dourado text-dourado rounded-xl">Cancelar</button>}
                            </div>
                        </form>
                    </div>

                    <div className="lg:col-span-2 bg-cinzaEscuro border-2 border-dourado p-4 rounded-2xl shadow">
                        <h3 className="font-bold mb-3 text-dourado">Lista de Produtos</h3>
                        <div className="overflow-x-auto">
                            <table className="w-full text-sm">
                                <thead className="bg-preto border-b-2 border-dourado">
                                    <tr>
                                        <th className="p-3 text-left text-dourado">Produto</th>
                                        <th className="p-3 text-left text-dourado">Categoria</th>
                                        <th className="p-3 text-right text-dourado">Pre√ßo</th>
                                        <th className="p-3 text-right text-dourado">Estoque</th>
                                        <th className="p-3 text-center text-dourado">A√ß√µes</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {produtos.map(p => (
                                        <tr key={p.id} className="border-b border-dourado/30 hover:bg-preto transition text-white">
                                            <td className="p-3">{p.nome}</td>
                                            <td className="p-3">{p.categoria}</td>
                                            <td className="p-3 text-right text-dourado">{currency(p.preco)}</td>
                                            <td className={`p-3 text-right ${p.estoque <= 10 ? 'text-red-400 font-bold' : 'text-white'}`}>{p.estoque <= 10 ? (<span className="inline-flex items-center gap-2 px-2 py-1 rounded-full bg-red-900/30">‚ö†Ô∏è {p.estoque}</span>) : p.estoque}</td>
                                            <td className="p-3 text-center">
                                                <div className="flex items-center justify-center gap-3">
                                                    <button onClick={() => editar(p)} className="text-dourado hover:underline">Editar</button>
                                                    <button onClick={() => excluir(p)} className="text-red-400 hover:underline">Excluir</button>
                                                </div>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            );
        }

        /*************************
         * Charts: Chart.js refs *
         *************************/
        function RelatoriosView({ vendas, produtos }) {
            const areaRef = useRef(null);
            const barRef = useRef(null);

            // build series by day
            const series = useMemo(() => {
                const map = {};
                vendas.forEach(v => {
                    const day = v.data.split('T')[0];
                    map[day] = (map[day] || 0) + v.total;
                });
                const arr = Object.entries(map).map(([d, t]) => ({ date: d, total: t }));
                arr.sort((a, b) => a.date.localeCompare(b.date));
                return arr;
            }, [vendas]);

            // C√°lculo do Top Produtos
            const top = useMemo(() => {
                const vendaMap = {};
                let totalUnidadesVendidas = 0; // Para calcular a distribui√ß√£o

                vendas.forEach(v => {
                    v.itens.forEach(it => {
                        produtos.forEach(p => {
                            if (p.id === it.id) {
                                vendaMap[it.id] = vendaMap[it.id] || { nome: it.nome, quantidade: 0, total: 0 };
                                vendaMap[it.id].quantidade += it.quantidade;
                                vendaMap[it.id].total += it.preco * it.quantidade;
                                totalUnidadesVendidas += it.quantidade; // Soma total
                            }
                        })
                    });
                });

                const topProdutosComDistribuicao = Object.values(vendaMap)
                    .sort((a, b) => b.quantidade - a.quantidade)
                    .slice(0, 6)
                    .map(p => ({
                        ...p,
                        // Calcula o percentual: (quantidade do produto / total de unidades vendidas) * 100
                        distribuicao: totalUnidadesVendidas > 0 ? (p.quantidade / totalUnidadesVendidas) * 100 : 0
                    }));
                    
                return {
                    list: topProdutosComDistribuicao,
                    totalUnidades: totalUnidadesVendidas
                };
            }, [vendas, produtos]);


            // render charts
            useEffect(() => {
                // Destr√≥i gr√°ficos antigos
                if (areaRef.current && areaRef.current._chart) { try { areaRef.current._chart.destroy(); } catch { } }
                if (barRef.current && barRef.current._chart) { try { barRef.current._chart.destroy(); } catch { } }

                // Gr√°fico de Receita por Dia
                if (areaRef.current && series.length > 0) {
                    const ctx = areaRef.current.getContext('2d');
                    const labels = series.map(s => s.date.substring(5)); // Ex: 11-21
                    const data = series.map(s => s.total);
                    areaRef.current._chart = new Chart(ctx, {
                        type: 'line',
                        data: { labels, datasets: [{ label: 'Receita (R$)', data, fill: true, tension: 0.3, borderColor: '#D4AF37', backgroundColor: 'rgba(212,175,55,0.2)' }] },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                tooltip: {
                                    callbacks: {
                                        label: ctx => 'Receita: ' + currency(ctx.raw)
                                    }
                                },
                                legend: { labels: { color: '#D4AF37' } }
                            },
                            scales: {
                                y: { beginAtZero: true, ticks: { color: '#D4AF37' } },
                                x: { ticks: { color: 'white' } }
                            }
                        }
                    });
                }

                // Gr√°fico de Barras Top Produtos
                if (barRef.current && top.list.length > 0) {
                    const ctx = barRef.current.getContext('2d');
                    const labels = top.list.map(t => t.nome);
                    const data = top.list.map(t => t.quantidade);
                    barRef.current._chart = new Chart(ctx, {
                        type: 'bar',
                        data: { labels, datasets: [{ label: 'Quantidade Vendida', data, backgroundColor: '#D4AF37' }] },
                        options: {
                            indexAxis: 'y',
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { labels: { color: '#D4AF37' } }
                            },
                            scales: {
                                x: { beginAtZero: true, ticks: { color: '#D4AF37' } },
                                y: { ticks: { color: 'white' } }
                            }
                        }
                    });
                }
            }, [series, top.list]);

            return (
                <div className="space-y-4">
                    <h2 className="text-3xl font-extrabold text-dourado border-b border-dourado/50 pb-2 flex items-center gap-3">
                        <span className="text-4xl">üìä</span> Relat√≥rios B√°sicos
                    </h2>

                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-4">
                        <div className="lg:col-span-2 bg-cinzaEscuro border-2 border-dourado p-4 rounded-2xl shadow">
                            <h4 className="font-bold mb-2 text-dourado">Receita por dia</h4>
                            <div style={{ height: 240 }}>
                                {series.length > 0 ? (
                                    <canvas ref={areaRef}></canvas>
                                ) : (
                                    <div className="text-gray-400 text-center py-10">N√£o h√° dados de vendas para o gr√°fico.</div>
                                )}
                            </div>
                        </div>

                        {/* Card de Distribui√ß√£o e Top Produtos */}
                        <div className="bg-cinzaEscuro border-2 border-dourado p-4 rounded-2xl shadow">
                            <h4 className="font-bold mb-3 text-dourado">Distribui√ß√£o de Vendas (Top 6)</h4>
                            
                            {top.list.length > 0 ? (
                                <div className="space-y-3">
                                    {top.list.map((p, index) => (
                                        <div key={p.nome} className="text-sm">
                                            <div className="flex justify-between items-center text-white">
                                                <span className="font-medium truncate">{index + 1}. {p.nome}</span>
                                                <span className="font-bold text-dourado">{p.distribuicao.toFixed(1)}%</span>
                                            </div>
                                            <div className="mt-1 w-full bg-preto rounded-full h-2">
                                                <div 
                                                    className="h-2 rounded-full bg-gradient-to-r from-douradoEscuro to-dourado"
                                                    style={{ width: `${p.distribuicao}%` }}
                                                ></div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            ) : (
                                <div className="text-gray-400 text-center py-6">N√£o h√° dados de vendas.</div>
                            )}
                        </div>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div className="bg-cinzaEscuro border-2 border-dourado p-4 rounded-2xl shadow">
                            <h4 className="font-bold mb-2 text-dourado">Top 6 produtos mais vendidos (unidades)</h4>
                            <div style={{ height: 240 }}>
                                {top.list.length > 0 ? (
                                    <canvas ref={barRef}></canvas>
                                ) : (
                                    <div className="text-gray-400 text-center py-10">N√£o h√° dados de vendas para o gr√°fico.</div>
                                )}
                            </div>
                        </div>
                        
                        <div className="bg-cinzaEscuro border-2 border-dourado p-4 rounded-2xl shadow">
                            <h4 className="font-bold mb-2 text-dourado">Produtos com estoque baixo (‚â§ 10)</h4>
                            <div className="overflow-x-auto">
                                <table className="w-full text-sm">
                                    <thead className="bg-preto border-b-2 border-dourado">
                                        <tr>
                                            <th className="p-2 text-left text-dourado">Produto</th>
                                            <th className="p-2 text-left text-dourado">Categoria</th>
                                            <th className="p-2 text-right text-dourado">Estoque</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {produtos.filter(p => p.estoque <= 10).map(p => (
                                            <tr key={p.id} className="border-b border-dourado/30 hover:bg-preto text-white">
                                                <td className="p-2 font-semibold">{p.nome}</td>
                                                <td className="p-2">{p.categoria}</td>
                                                <td className="p-2 text-right text-red-400 font-bold">{p.estoque}</td>
                                            </tr>
                                        ))}
                                        {produtos.filter(p => p.estoque <= 10).length === 0 && <tr><td colSpan="3" className="p-4 text-center text-gray-400">Todos os produtos com estoque adequado</td></tr>}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        function RelatorioAvancado({ vendas, produtos }) {
            const [from, setFrom] = useState('');
            const [to, setTo] = useState('');
            const [chartType, setChartType] = useState('pie'); // 'pie' ou 'bar'
            const chartRef = useRef(null);

            // 1. Filtrar Vendas
            const vendasFiltradas = useMemo(() => {
                let filtered = vendas;
                if (from) {
                    filtered = filtered.filter(v => v.data.split('T')[0] >= from);
                }
                if (to) {
                    filtered = filtered.filter(v => v.data.split('T')[0] <= to);
                }
                return filtered;
            }, [vendas, from, to]);

            // 2. C√°lculos de Estat√≠sticas
            const stats = useMemo(() => {
                const totalVendas = vendasFiltradas.length;
                const receitaTotal = vendasFiltradas.reduce((acc, v) => acc + v.total, 0);
                const ticketMedio = totalVendas > 0 ? receitaTotal / totalVendas : 0;

                const produtosVendidos = {};
                vendasFiltradas.forEach(v => {
                    v.itens.forEach(item => {
                        // Usamos o nome do item da venda, que √© mais seguro caso o produto mude de nome
                        produtosVendidos[item.id] = produtosVendidos[item.id] || { nome: item.nome, quantidade: 0, total: 0 };
                        produtosVendidos[item.id].quantidade += item.quantidade;
                        produtosVendidos[item.id].total += item.preco * item.quantidade;
                    });
                });

                const topProdutos = Object.values(produtosVendidos).sort((a, b) => b.quantidade - a.quantidade).slice(0, 6);

                return {
                    totalVendas,
                    receitaTotal,
                    ticketMedio,
                    topProdutos
                };
            }, [vendasFiltradas]);

            // 3. Renderizar Gr√°fico
            useEffect(() => {
                // Garante que o gr√°fico seja destru√≠do antes de recriar
                if (chartRef.current && chartRef.current._chart) { 
                    try { 
                        chartRef.current._chart.destroy(); 
                    } catch { 
                        // Ignorar erro se o gr√°fico j√° foi destru√≠do ou n√£o existe
                    } 
                }

                if (chartRef.current && stats.topProdutos.length > 0) {
                    const ctx = chartRef.current.getContext('2d');
                    const labels = stats.topProdutos.map(t => t.nome);
                    const data = chartType === 'pie' ? stats.topProdutos.map(t => t.quantidade) : stats.topProdutos.map(t => t.total);

                    const colors = ['#D4AF37', '#B8941F', '#8b7024', '#6b5a1d', '#4a3f15', '#2d2710'];

                    const type = chartType === 'pie' ? 'pie' : 'bar';
                    const labelPrefix = chartType === 'pie' ? 'unidades' : 'R$';

                    chartRef.current._chart = new Chart(ctx, {
                        type: type,
                        data: {
                            labels,
                            datasets: [{
                                label: chartType === 'pie' ? 'Quantidade Vendida' : 'Receita Gerada',
                                data,
                                backgroundColor: colors,
                                borderColor: '#1a1a1a',
                                borderWidth: 2
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            indexAxis: type === 'bar' ? 'y' : 'x',
                            plugins: {
                                legend: {
                                    position: type === 'pie' ? 'right' : 'top',
                                    labels: { color: '#D4AF37', font: { size: 12 } }
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function (context) {
                                            const value = type === 'pie' ? context.parsed : currency(context.parsed);
                                            return `${context.label}: ${value} ${labelPrefix}`;
                                        }
                                    }
                                }
                            },
                            scales: type === 'bar' ? {
                                x: { beginAtZero: true, ticks: { color: '#D4AF37' } },
                                y: { ticks: { color: 'white' } }
                            } : {}
                        }
                    });
                }
            }, [vendasFiltradas, chartType, stats.topProdutos]);


            return (
                <div className="space-y-6">
                    <h2 className="text-3xl font-extrabold text-dourado border-b border-dourado/50 pb-2 flex items-center gap-3">
                        <span className="text-4xl">üìà</span> Relat√≥rio Avan√ßado de Vendas
                    </h2>

                    {/* Filtros e Estat√≠sticas */}
                    <div className="bg-cinzaEscuro border-2 border-dourado p-4 rounded-2xl shadow">
                        <h3 className="font-bold mb-3 text-white">Filtros de Per√≠odo</h3>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <label className="block">
                                <span className="text-sm text-gray-300">Data Inicial</span>
                                <input type="date" value={from} onChange={e => setFrom(e.target.value)} className="mt-1 block w-full p-3 border border-dourado bg-preto text-white rounded-xl focus:ring-2 focus:ring-dourado transition" />
                            </label>
                            <label className="block">
                                <span className="text-sm text-gray-300">Data Final</span>
                                <input type="date" value={to} onChange={e => setTo(e.target.value)} className="mt-1 block w-full p-3 border border-dourado bg-preto text-white rounded-xl focus:ring-2 focus:ring-dourado transition" />
                            </label>
                        </div>

                        <div className="mt-6 grid grid-cols-3 gap-4">
                            <div className="bg-preto p-3 rounded-xl border border-dourado text-center">
                                <div className="text-xs text-gray-400">Total de Vendas</div>
                                <div className="font-bold text-lg text-white">{stats.totalVendas}</div>
                            </div>
                            <div className="bg-preto p-3 rounded-xl border border-dourado text-center">
                                <div className="text-xs text-gray-400">Receita Total</div>
                                <div className="font-bold text-lg text-dourado">{currency(stats.receitaTotal)}</div>
                            </div>
                            <div className="bg-preto p-3 rounded-xl border border-dourado text-center">
                                <div className="text-xs text-gray-400">Ticket M√©dio</div>
                                <div className="font-bold text-lg text-white">{currency(stats.ticketMedio)}</div>
                            </div>
                        </div>
                    </div>

                    {/* Gr√°fico Top Produtos */}
                    <div className="bg-cinzaEscuro border-2 border-dourado p-4 rounded-2xl shadow">
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="font-bold text-dourado">Top Produtos no Per√≠odo</h3>
                            <div className="flex gap-2">
                                <button onClick={() => setChartType('pie')} className={`px-3 py-1 text-sm rounded-lg border ${chartType === 'pie' ? 'bg-dourado text-preto border-dourado' : 'text-dourado border-dourado hover:bg-preto'}`}>Quantidade (Pizza)</button>
                                <button onClick={() => setChartType('bar')} className={`px-3 py-1 text-sm rounded-lg border ${chartType === 'bar' ? 'bg-dourado text-preto border-dourado' : 'text-dourado border-dourado hover:bg-preto'}`}>Receita (Barra)</button>
                            </div>
                        </div>
                        <div style={{ height: 350 }}>
                            {stats.topProdutos.length > 0 ? (
                                <canvas ref={chartRef}></canvas>
                            ) : (
                                <div className="text-gray-400 text-center py-10">Nenhuma venda registrada no per√≠odo selecionado.</div>
                            )}
                        </div>
                    </div>

                    {/* Tabela de Vendas Detalhada */}
                    <div className="bg-cinzaEscuro border-2 border-dourado p-4 rounded-2xl shadow">
                        <h3 className="font-bold mb-3 text-dourado">Detalhe das Vendas ({vendasFiltradas.length})</h3>
                        <div className="overflow-x-auto">
                            <table className="w-full text-sm">
                                <thead className="bg-preto border-b-2 border-dourado">
                                    <tr>
                                        <th className="p-3 text-left text-dourado">ID Venda</th>
                                        <th className="p-3 text-left text-dourado">Data</th>
                                        <th className="p-3 text-left text-dourado">Qtd. Itens</th>
                                        <th className="p-3 text-right text-dourado">Total</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {vendasFiltradas.map(v => (
                                        <tr key={v.id} className="border-b border-dourado/30 hover:bg-preto transition text-white">
                                            <td className="p-3">{v.id}</td>
                                            <td className="p-3">{new Date(v.data).toLocaleString('pt-BR', { timeZone: 'UTC', year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' })}</td>
                                            <td className="p-3">{v.itens.reduce((acc, it) => acc + it.quantidade, 0)}</td>
                                            <td className="p-3 text-right text-dourado font-bold">{currency(v.total)}</td>
                                        </tr>
                                    ))}
                                    {vendasFiltradas.length === 0 && <tr><td colSpan="4" className="p-4 text-center text-gray-400">Nenhuma venda encontrada para o per√≠odo.</td></tr>}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            );
        }

        /********
         * APP *
         ********/
        function App() {
            const [user, setUser] = useState(storageGet('user'));
            const [selectedView, setSelectedView] = useState('pdv');
            const [produtos, setProdutos] = useState(storageGet('produtos', initialProdutosDefault));
            const [vendas, setVendas] = useState(storageGet('vendas', []));
            const [carrinho, setCarrinho] = useState([]);
            const [buscaPDV, setBuscaPDV] = useState('');

            useEffect(() => { storageSet('produtos', produtos); }, [produtos]);
            useEffect(() => { storageSet('vendas', vendas); }, [vendas]);
            useEffect(() => { storageSet('user', user); }, [user]);

            function handleLogin(u) { setUser(u); setSelectedView('pdv'); }
            function handleLogout() { setUser(null); storageSet('user', null); }
            function salvarProdutos(novos) { setProdutos(novos); }

            // L√≥gica do Carrinho
            const totalCarrinho = useMemo(() => carrinho.reduce((acc, item) => acc + (item.preco * item.quantidade), 0), [carrinho]);

            function adicionarAoCarrinho(produto) {
                const itemExistente = carrinho.find(item => item.id === produto.id);

                const produtoEmEstoque = produtos.find(p => p.id === produto.id);

                if (produtoEmEstoque.estoque <= (itemExistente?.quantidade || 0)) {
                    alert(`Estoque insuficiente para ${produto.nome}. M√°ximo: ${produtoEmEstoque.estoque}`);
                    return;
                }

                if (itemExistente) {
                    setCarrinho(carrinho.map(item => item.id === produto.id ? { ...item, quantidade: item.quantidade + 1 } : item));
                } else {
                    setCarrinho([...carrinho, { ...produto, quantidade: 1 }]);
                }
            }

            function alterarQuantidade(id, novaQuantidade) {
                const produtoEmEstoque = produtos.find(p => p.id === id);

                if (novaQuantidade <= 0) {
                    removerDoCarrinho(id);
                } else if (novaQuantidade > produtoEmEstoque.estoque) {
                    alert(`Estoque insuficiente para ${produtoEmEstoque.nome}. M√°ximo: ${produtoEmEstoque.estoque}`);
                } else {
                    setCarrinho(carrinho.map(item => item.id === id ? { ...item, quantidade: novaQuantidade } : item));
                }
            }

            function removerDoCarrinho(id) {
                setCarrinho(carrinho.filter(item => item.id !== id));
            }

            function finalizarVenda() {
                if (carrinho.length === 0) {
                    alert('O carrinho est√° vazio!');
                    return;
                }

                // 1. Registrar a Venda
                const novaVenda = {
                    id: uid(),
                    data: new Date().toISOString(),
                    itens: carrinho.map(i => ({ id: i.id, nome: i.nome, preco: i.preco, quantidade: i.quantidade })),
                    total: totalCarrinho
                };
                setVendas([...vendas, novaVenda]);

                // 2. Atualizar Estoque
                const novosProdutos = produtos.map(p => {
                    const itemVendido = carrinho.find(i => i.id === p.id);
                    if (itemVendido) {
                        return { ...p, estoque: p.estoque - itemVendido.quantidade };
                    }
                    return p;
                });
                setProdutos(novosProdutos);

                // 3. Limpar Carrinho
                setCarrinho([]);

                alert(`Venda finalizada! Total: ${currency(totalCarrinho)}`);
            }

            // Renderiza√ß√£o
            if (!user) {
                return <Login onLogin={handleLogin} />;
            }

            return (
                // Container que ocupa toda a tela e √© Flex (coluna)
                <div className="min-h-screen flex flex-col text-white">
                    <Header user={user} onLogout={handleLogout} />
                    
                    {/* CORRE√á√ÉO CHAVE: √Årea de Conte√∫do Lateral (Sidebar + Main) */}
                    <div className="flex flex-1 overflow-hidden"> 
                        <Sidebar selected={selectedView} setSelected={setSelectedView} />
                        
                        {/* O <main> √© o elemento que DEVE ter o scroll. O overflow-y-auto garante o scroll. */}
                        <main className="flex-1 p-6 overflow-y-auto">
                            {selectedView === 'pdv' && <PDVView
                                produtos={produtos}
                                adicionarAoCarrinho={adicionarAoCarrinho}
                                busca={buscaPDV}
                                setBusca={setBuscaPDV}
                                carrinho={carrinho}
                                alterarQuantidade={alterarQuantidade}
                                removerDoCarrinho={removerDoCarrinho}
                                finalizarVenda={finalizarVenda}
                                totalCarrinho={totalCarrinho}
                            />}
                            {selectedView === 'produtos' && <ProdutosView produtos={produtos} salvarProdutos={salvarProdutos} />}
                            {selectedView === 'relatorios' && <RelatoriosView vendas={vendas} produtos={produtos} />}
                            {selectedView === 'avancado' && <RelatorioAvancado vendas={vendas} produtos={produtos} />}
                        </main>
                    </div>
                </div>
            );
        }

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>

</body>

</html>